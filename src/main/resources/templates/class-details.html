<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Class Details</title>
  <style>

    body {
      margin: 0;
      padding: 0;
    }

    .page-content {
      margin-top: 70px;
      padding: 20px;
    }

    img {
      height: 600px;
      width: auto;
    }

  </style>
</head>
<body>
<!-- Navbar -->
<div th:insert="fragments/nav :: navigation"></div>

<!-- Main Content -->
<div class="page-content">
<img th:src="@{{imageName}(imageName=${classDetails.classImage})}" alt="Class Image">
<h1>You've chosen: <span th:text="${classDetails.className}"></span></h1>

<p th:if="${classDetails != null}">
  <span th:text="${classDetails.classDescription}">Class information not available.</span>
</p>
<p><strong>Hit Point Die:</strong> D<span th:text="${classDetails.hitDie}"></span></p>
<p><strong> Saving Throw Proficiencies:</strong> <span th:text="${classDetails.savingThrowsFormatted}"></span></p>

<!-- Display Proficiency Choices -->
<div class="section-title"><strong>Choose Two Skill Proficiencies:</strong></div>
<div class="section-content">
  <div th:each="proficiency : ${classDetails.proficiencyNames}">
    <!-- Filter to show only skills and remove 'Skill:' from the display -->
    <div th:if="${proficiency.startsWith('Skill:')}">
      <label>
        <input type="checkbox" name="chosenProficiencies" th:value="${proficiency}" onclick="limitCheckboxes(this)">
        <span th:text="${proficiency.substring(6)}"></span> <!-- Remove "Skill:" -->
      </label>
    </div>
  </div>
</div>


<br>

<!-- Proficiencies Section -->
<div class="section-title"><strong>Weapon and Armour Proficiencies:</strong></div>
<div class="section-content" th:if="${classDetails.proficiencies != null}">
  <ul>
    <li th:each="proficiency : ${classDetails.proficiencies}">
      <span th:text="${proficiency.name}"></span><br>
    </li>
    <li th:if="${#lists.isEmpty(classDetails.proficiencies)}">No proficiencies available.</li>
  </ul>
</div>

<!-- Cantrips Section (Level 0 Spells) -->
<div class="section-title" th:if="${#lists.isEmpty(cantrips)}"><strong>Cantrips:</strong></div>
<div class="section-content" th:if="${#lists.isEmpty(cantrips)}">
  <p>This class knows no cantrips.</p>
</div>
<div class="section-title" th:unless="${#lists.isEmpty(cantrips)}"><strong>Cantrips:</strong></div>
<div class="section-content" th:unless="${#lists.isEmpty(cantrips)}">
  <ul>
    <li th:each="spell : ${cantrips}">
      <span th:text="${spell.name}"></span>
    </li>
  </ul>
</div>

<!-- Spells Section (Level 1 Spells) -->
<div class="section-title" th:if="${#lists.isEmpty(level1Spells)}"><strong>Spells:</strong></div>
<div class="section-content" th:if="${#lists.isEmpty(level1Spells)}">
  <p>This class knows no spells.</p>
</div>
<div class="section-title" th:unless="${#lists.isEmpty(level1Spells)}"><strong>Spells:</strong></div>
<div class="section-content" th:unless="${#lists.isEmpty(level1Spells)}">
  <ul>
    <li th:each="spell : ${level1Spells}">
      <span th:text="${spell.name}"></span>
    </li>
  </ul>
</div>

<!-- Starting Equipment Section -->
<div class="section-title"><strong>Starting Equipment:</strong></div>
<div class="section-content" th:if="${classDetails.startingEquipment != null}">
  <ul>
    <li th:each="equipment : ${classDetails.startingEquipment}">
      <span th:text="${equipment.quantity}"></span>
      x
      <a th:text="${equipment.name}"></a>
    </li>
    <li th:if="${#lists.isEmpty(classDetails.startingEquipment)}">No starting equipment available.</li>
  </ul>
</div>

<!-- Optional Starting Equipment Section -->
<div class="section-title"><strong>Optional Starting Equipment:</strong></div>
<div th:each="option : ${classDetails.startingEquipmentOptions}">
  <p th:text="${stringUtils.capitalizeWords(#strings.replace(#strings.replace(option.desc, ', ', ' OR '), ' OR  ', ' OR '))}"></p>
</div>


<!-- Back Link -->
<a th:href="@{/choose-class/character/{characterId}(characterId=${characterId})}" class="back">Go Back</a>

<!-- Combined Form: Submit Class and Chosen Proficiencies -->
<form id="updateClassAndProficienciesForm" th:action="@{/update-class-name}" method="post">
  <input type="hidden" name="_method" value="PATCH">
  <input type="hidden" id="className" name="className" th:value="${classDetails.className}">
  <input type="hidden" id="characterId" name="characterId" th:value="${characterId}">

  <!-- Submit Button -->
  <button type="submit">Confirm Class</button>
</form>

<script>
  // JavaScript to limit the number of checked checkboxes to 2
  function limitCheckboxes(checkbox) {
    const maxSelections = 2;
    const checkboxes = document.querySelectorAll('input[name="chosenProficiencies"]:checked');

    if (checkboxes.length > maxSelections) {
      // If more than 2 checkboxes are ticked, untick the last one and show an alert
      checkbox.checked = false;
      alert("You can only select two skill proficiencies.");
    } else {
      // Disable or grey out checkboxes when the limit is reached
      const allCheckboxes = document.querySelectorAll('input[name="chosenProficiencies"]');
      allCheckboxes.forEach(function (box) {
        if (checkboxes.length === maxSelections && !box.checked) {
          box.disabled = true;  // Disable unselected checkboxes
          box.parentElement.style.color = 'gray';  // Optional: Grey out the label
        } else {
          box.disabled = false;
          box.parentElement.style.color = '';  // Reset label color
        }
      });
    }
  }

  // Ensure only selected proficiencies are sent when the form is submitted
  document.getElementById('updateClassAndProficienciesForm').addEventListener('submit', function(event) {
    // Create an array of selected proficiency values
    const selectedProficiencies = [];
    document.querySelectorAll('input[name="chosenProficiencies"]:checked').forEach(function(checkbox) {
      selectedProficiencies.push(checkbox.value);
    });

    // Ensure exactly 2 proficiencies are selected
    if (selectedProficiencies.length !== 2) {
      event.preventDefault();  // Prevent form submission
      alert("You must select exactly two skill proficiencies.");
    } else {
      // Manually add the selected proficiencies to the form before submission
      const proficiencyInput = document.createElement('input');
      proficiencyInput.type = 'hidden';
      proficiencyInput.name = 'chosenProficiencies';
      proficiencyInput.value = selectedProficiencies.join(',');  // Join selected proficiencies
      this.appendChild(proficiencyInput);
    }
  });

  // Prevent form submission if no equipment option is selected
  document.getElementById('updateClassAndEquipmentForm').addEventListener('submit', function(event) {
    const selectedEquipment = document.querySelector('input[name="chosenEquipment"]:checked');

    if (!selectedEquipment) {
      event.preventDefault();  // Prevent form submission
      alert("You must select one piece of optional starting equipment.");
    } else {
      // Optionally, add the selected equipment to a hidden field if needed for later processing
      const equipmentInput = document.createElement('input');
      equipmentInput.type = 'hidden';
      equipmentInput.name = 'chosenEquipment';
      equipmentInput.value = selectedEquipment.value;  // Capture the selected equipment name
      this.appendChild(equipmentInput);
    }
  });
</script>
</div>
</body>
</html>